# CapsWriter 故障排除指南

## 🐛 已知问题及解决方案

### 问题1：间歇性录音失败（波形显示相关）

**症状描述：**
- 第一次录音正常，第二次或后续录音可能失败
- 按下CapsLock键无反应，没有波形显示
- 问题不是必现，时好时坏

**根本原因：**
1. **线程安全问题**：tkinter窗口在子线程创建，GUI操作需要主线程执行
2. **资源清理不彻底**：窗口销毁时有残留引用，影响下次创建
3. **异常处理不足**：tkinter操作失败时影响整个程序流程

**解决方案：**
1. **改进窗口销毁机制**：
   ```python
   # 使用window.after()在主线程中安全销毁
   self.window.after(0, self._safe_destroy)
   ```

2. **增强异常处理**：
   ```python
   # 所有tkinter操作包装在try-catch中
   try:
       waveform_window.show()
   except Exception as e:
       print(f"[调试] 显示波形失败: {e}")
   ```

3. **改进资源管理**：
   ```python
   # 显示前确保旧窗口完全清理
   if self.window:
       self.hide()
       time.sleep(0.1)
   ```

**修复文件：**
- `util/waveform_display.py` - 主要修复文件
- `util/keyboard_handler.py` - 添加异常处理
- `config.py` - 添加调试开关

**应急方案：**
如果问题复现，可临时禁用波形显示：
```python
# 在config.py中设置
debug_disable_waveform = True
```

**验证方法：**
1. 连续录音5-10次，观察是否稳定
2. 查看调试信息，确认无波形相关错误
3. 如有问题，启用调试模式分析

---

## 🔧 调试工具

### 调试模式
在 `config.py` 中设置：
```python
debug_disable_waveform = True  # 禁用波形显示
```

### 调试信息
程序会输出详细调试信息：
- `[调试] 键盘事件: down/up`
- `[调试] 按下按键，启动录音`
- `[调试] 显示波形窗口`
- `[调试] 录音完成，持续时间: X.XX秒`

### 测试脚本
```bash
# 使用禁用波形的测试版本
python test_without_waveform.py
```

---

## 📝 问题排查步骤

1. **确认问题类型**：
   - 键盘监听问题：无任何调试输出
   - 录音启动问题：有键盘事件但无录音启动
   - 波形问题：对比启用/禁用波形的差异

2. **收集调试信息**：
   - 启用详细调试输出
   - 记录问题复现的具体步骤
   - 观察错误信息模式

3. **逐步排除**：
   - 先禁用波形测试基础功能
   - 再启用波形测试修复效果
   - 必要时重启键盘监听

---

## 🚀 预防措施

1. **定期测试**：每次修改后进行多次连续录音测试
2. **异常监控**：关注调试信息中的异常报告
3. **资源管理**：确保所有GUI资源正确清理
4. **线程安全**：避免在子线程中直接操作GUI组件

---

*最后更新：2024年12月*